<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MailFlow â€” Unified Inbox</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f11;
    --surface: #17171b;
    --surface2: #1e1e24;
    --surface3: #26262e;
    --border: #2e2e38;
    --accent: #6c63ff;
    --accent2: #ff6584;
    --text: #f0eff8;
    --text2: #9998b0;
    --text3: #5f5e78;
    --sent: #22c55e;
    --unread-dot: #6c63ff;
    --shadow: 0 8px 32px rgba(0,0,0,0.4);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* â”€â”€ TOP BAR â”€â”€ */
  .topbar {
    display: flex;
    align-items: center;
    padding: 0 24px;
    height: 56px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    gap: 16px;
    flex-shrink: 0;
    z-index: 100;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    color: var(--text);
    letter-spacing: -0.5px;
    margin-right: 8px;
  }
  .logo span { color: var(--accent); }

  .search-bar {
    flex: 1;
    max-width: 480px;
    display: flex;
    align-items: center;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0 14px;
    gap: 8px;
    height: 36px;
    transition: border-color 0.2s;
  }
  .search-bar:focus-within { border-color: var(--accent); }
  .search-bar input {
    background: none;
    border: none;
    outline: none;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    width: 100%;
  }
  .search-bar input::placeholder { color: var(--text3); }
  .search-icon { color: var(--text3); font-size: 14px; }

  .topbar-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }

  .btn-refresh {
    display: flex; align-items: center; gap: 6px;
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    padding: 7px 14px;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-refresh:hover { opacity: 0.88; }
  .btn-refresh:active { transform: scale(0.97); }
  .btn-refresh.loading { opacity: 0.6; pointer-events: none; }

  .status-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--sent);
    box-shadow: 0 0 6px var(--sent);
  }
  .status-dot.offline { background: var(--accent2); box-shadow: 0 0 6px var(--accent2); }

  /* â”€â”€ MAIN LAYOUT â”€â”€ */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* â”€â”€ SIDEBAR â”€â”€ */
  .sidebar {
    width: 220px;
    flex-shrink: 0;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 16px 0;
    overflow-y: auto;
  }

  .sidebar-section-title {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--text3);
    padding: 0 20px;
    margin-bottom: 6px;
    margin-top: 16px;
  }
  .sidebar-section-title:first-child { margin-top: 0; }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 20px;
    font-size: 13.5px;
    font-weight: 400;
    color: var(--text2);
    cursor: pointer;
    border-radius: 0;
    transition: background 0.15s, color 0.15s;
    position: relative;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active {
    background: rgba(108,99,255,0.12);
    color: var(--accent);
    font-weight: 500;
  }
  .nav-item.active::before {
    content: '';
    position: absolute;
    left: 0; top: 50%;
    transform: translateY(-50%);
    width: 3px; height: 60%;
    background: var(--accent);
    border-radius: 0 2px 2px 0;
  }
  .nav-item .icon { font-size: 15px; width: 18px; text-align: center; }
  .nav-badge {
    margin-left: auto;
    background: var(--accent);
    color: white;
    font-size: 10px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 20px;
    min-width: 18px;
    text-align: center;
  }

  .account-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 7px 20px;
    font-size: 12px;
    color: var(--text2);
    cursor: pointer;
    transition: background 0.15s;
  }
  .account-item:hover { background: var(--surface2); }
  .account-item.active { color: var(--accent); font-weight: 500; }
  .account-avatar {
    width: 22px; height: 22px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 700; color: white;
    flex-shrink: 0;
  }

  /* â”€â”€ EMAIL LIST â”€â”€ */
  .email-list-panel {
    width: 380px;
    flex-shrink: 0;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .panel-header {
    padding: 16px 20px 12px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .panel-title {
    font-family: 'DM Serif Display', serif;
    font-size: 18px;
    color: var(--text);
  }
  .panel-count {
    font-size: 12px;
    color: var(--text3);
    background: var(--surface3);
    padding: 2px 8px;
    border-radius: 20px;
  }

  .filter-tabs {
    display: flex;
    gap: 4px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .filter-tab {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    color: var(--text3);
    transition: all 0.15s;
    border: none;
    background: none;
    font-family: 'DM Sans', sans-serif;
  }
  .filter-tab:hover { background: var(--surface3); color: var(--text2); }
  .filter-tab.active { background: var(--accent); color: white; font-weight: 500; }

  .email-list {
    overflow-y: auto;
    flex: 1;
  }

  .email-list::-webkit-scrollbar { width: 4px; }
  .email-list::-webkit-scrollbar-track { background: transparent; }
  .email-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .email-item {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.12s;
    position: relative;
  }
  .email-item:hover { background: var(--surface2); }
  .email-item.active { background: rgba(108,99,255,0.1); border-left: 2px solid var(--accent); padding-left: 18px; }
  .email-item.unread .email-from { font-weight: 600; color: var(--text); }
  .email-item.unread .email-subject { color: var(--text); font-weight: 500; }

  .email-item-top {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
  }
  .email-avatar {
    width: 34px; height: 34px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700; color: white;
    flex-shrink: 0;
  }
  .email-meta { flex: 1; min-width: 0; }
  .email-from {
    font-size: 13.5px;
    color: var(--text2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .email-time { font-size: 11px; color: var(--text3); flex-shrink: 0; }

  .email-subject {
    font-size: 12.5px;
    color: var(--text2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 4px;
    padding-left: 44px;
  }
  .email-preview {
    font-size: 12px;
    color: var(--text3);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding-left: 44px;
  }

  .unread-indicator {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--accent);
  }

  .inbox-tag {
    display: inline-flex;
    align-items: center;
    font-size: 9px;
    font-weight: 600;
    padding: 1px 5px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* â”€â”€ EMAIL DETAIL â”€â”€ */
  .email-detail {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg);
  }

  .detail-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text3);
    gap: 12px;
  }
  .detail-empty-icon { font-size: 48px; opacity: 0.3; }
  .detail-empty-text { font-size: 15px; }

  .detail-header {
    padding: 20px 28px 16px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .detail-subject {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    color: var(--text);
    margin-bottom: 12px;
    line-height: 1.3;
  }
  .detail-meta {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .detail-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px; font-weight: 700; color: white;
    flex-shrink: 0;
  }
  .detail-from-info { flex: 1; }
  .detail-from-name { font-size: 14px; font-weight: 500; color: var(--text); }
  .detail-from-email { font-size: 12px; color: var(--text3); }
  .detail-date { font-size: 12px; color: var(--text3); }

  .email-actions {
    display: flex;
    gap: 8px;
    margin-left: auto;
  }
  .action-btn {
    display: flex; align-items: center; gap: 5px;
    padding: 6px 12px;
    border-radius: 7px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text2);
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.15s;
  }
  .action-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(108,99,255,0.08); }
  .action-btn.primary { background: var(--accent); color: white; border-color: var(--accent); }
  .action-btn.primary:hover { opacity: 0.88; }

  .detail-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px 28px;
  }
  .detail-body::-webkit-scrollbar { width: 4px; }
  .detail-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .email-body-text {
    font-size: 14px;
    line-height: 1.75;
    color: var(--text2);
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* Thread */
  .thread-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 24px 0;
    color: var(--text3);
    font-size: 12px;
  }
  .thread-divider::before, .thread-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .thread-msg {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 16px;
  }
  .thread-msg-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }
  .thread-msg-from { font-size: 13px; font-weight: 500; color: var(--text); }
  .thread-msg-date { font-size: 11px; color: var(--text3); margin-left: auto; }
  .thread-msg-body { font-size: 13px; line-height: 1.7; color: var(--text2); white-space: pre-wrap; }

  /* Reply box */
  .reply-box {
    border-top: 1px solid var(--border);
    padding: 16px 28px;
    flex-shrink: 0;
    background: var(--surface);
  }
  .reply-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .reply-label { font-size: 12px; font-weight: 500; color: var(--text2); }
  .reply-to-addr { font-size: 12px; color: var(--text3); }

  .reply-textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13.5px;
    line-height: 1.6;
    padding: 12px 14px;
    resize: none;
    outline: none;
    min-height: 80px;
    max-height: 200px;
    transition: border-color 0.2s;
  }
  .reply-textarea:focus { border-color: var(--accent); }
  .reply-textarea::placeholder { color: var(--text3); }

  .reply-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 10px;
  }
  .reply-hint { font-size: 11px; color: var(--text3); }

  .btn-send {
    display: flex; align-items: center; gap: 6px;
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    padding: 8px 18px;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-send:hover { opacity: 0.88; }
  .btn-send:active { transform: scale(0.97); }
  .btn-send:disabled { opacity: 0.4; pointer-events: none; }

  /* Config modal */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 520px;
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    padding: 28px;
    transform: translateY(16px);
    transition: transform 0.2s;
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-title {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    margin-bottom: 6px;
  }
  .modal-subtitle { font-size: 13px; color: var(--text3); margin-bottom: 24px; }

  .form-group { margin-bottom: 16px; }
  .form-label { font-size: 12px; font-weight: 500; color: var(--text2); margin-bottom: 6px; display: block; }
  .form-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    padding: 9px 12px;
    outline: none;
    transition: border-color 0.2s;
  }
  .form-input:focus { border-color: var(--accent); }

  .account-list-config { margin-bottom: 16px; }
  .account-config-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 8px;
  }
  .account-config-email { font-size: 13px; color: var(--text); flex: 1; }
  .btn-remove {
    background: none;
    border: none;
    color: var(--accent2);
    cursor: pointer;
    font-size: 16px;
    padding: 2px 6px;
    border-radius: 4px;
    transition: background 0.15s;
  }
  .btn-remove:hover { background: rgba(255,101,132,0.12); }

  .modal-footer {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
  }
  .btn-cancel {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    padding: 8px 16px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .btn-cancel:hover { background: var(--surface3); }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px; right: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 18px;
    font-size: 13px;
    color: var(--text);
    display: flex; align-items: center; gap: 10px;
    box-shadow: var(--shadow);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 2000;
    max-width: 320px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { border-color: var(--sent); }
  .toast.error { border-color: var(--accent2); }
  .toast-icon { font-size: 16px; }

  /* Loading skeleton */
  .skeleton {
    background: linear-gradient(90deg, var(--surface2) 25%, var(--surface3) 50%, var(--surface2) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
  }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  .skeleton-row {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
  }
  .skeleton-line { height: 12px; margin-bottom: 8px; }
  .skeleton-line.short { width: 40%; }
  .skeleton-line.medium { width: 70%; }
  .skeleton-line.long { width: 90%; }

  /* Compose button */
  .compose-btn {
    margin: 12px 16px;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    background: var(--accent);
    border: none;
    border-radius: 10px;
    color: white;
    font-family: 'DM Sans', sans-serif;
    font-size: 13.5px;
    font-weight: 500;
    padding: 10px;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .compose-btn:hover { opacity: 0.88; }

  .settings-btn {
    margin: auto 16px 12px;
    display: flex; align-items: center; gap: 8px;
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text2);
    font-family: 'DM Sans', sans-serif;
    font-size: 12.5px;
    padding: 8px 12px;
    cursor: pointer;
    width: calc(100% - 32px);
    transition: background 0.15s;
  }
  .settings-btn:hover { background: var(--surface2); }

  .api-notice {
    background: rgba(108,99,255,0.08);
    border: 1px solid rgba(108,99,255,0.2);
    border-radius: 8px;
    padding: 12px 14px;
    font-size: 12px;
    color: var(--text2);
    margin-bottom: 16px;
    line-height: 1.6;
  }
  .api-notice a { color: var(--accent); text-decoration: none; }
  .api-notice a:hover { text-decoration: underline; }

  code {
    background: var(--surface3);
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 11px;
    color: var(--accent);
  }

  /* Compose modal */
  .compose-modal {
    position: fixed;
    bottom: 24px; right: 24px;
    width: 480px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    box-shadow: var(--shadow);
    z-index: 500;
    display: none;
    flex-direction: column;
    overflow: hidden;
  }
  .compose-modal.open { display: flex; }
  .compose-modal-header {
    padding: 14px 18px;
    background: var(--surface2);
    display: flex; align-items: center; justify-content: space-between;
    font-size: 13px; font-weight: 500; color: var(--text);
  }
  .compose-close {
    background: none; border: none; color: var(--text3);
    cursor: pointer; font-size: 18px; padding: 0 4px;
    transition: color 0.15s;
  }
  .compose-close:hover { color: var(--text); }
  .compose-field {
    padding: 8px 18px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
    font-size: 13px;
  }
  .compose-field label { color: var(--text3); min-width: 28px; font-size: 12px; }
  .compose-field input {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13px;
  }
  .compose-field input::placeholder { color: var(--text3); }
  .compose-body {
    flex: 1; padding: 14px 18px;
    min-height: 160px;
  }
  .compose-body textarea {
    width: 100%; height: 100%; min-height: 140px;
    background: none; border: none; outline: none; resize: none;
    color: var(--text); font-family: 'DM Sans', sans-serif;
    font-size: 13.5px; line-height: 1.7;
  }
  .compose-body textarea::placeholder { color: var(--text3); }
  .compose-footer {
    padding: 10px 18px;
    border-top: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }

  @media (max-width: 900px) {
    .sidebar { display: none; }
    .email-list-panel { width: 300px; }
  }
  @media (max-width: 640px) {
    .email-list-panel { width: 100%; }
    .email-detail { display: none; }
    .email-detail.show { display: flex; position: fixed; inset: 56px 0 0 0; z-index: 50; }
  }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo">Mail<span>Flow</span></div>
  <div class="search-bar">
    <span class="search-icon">ğŸ”</span>
    <input type="text" id="searchInput" placeholder="Search emailsâ€¦" oninput="filterEmails()">
  </div>
  <div class="topbar-right">
    <div class="status-dot" id="statusDot" title="Connected"></div>
    <button class="btn-refresh" id="refreshBtn" onclick="loadEmails()">
      <span id="refreshIcon">â†»</span> Refresh
    </button>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <button class="compose-btn" onclick="openCompose()">âœï¸ Compose</button>

    <div class="sidebar-section-title">Folders</div>
    <div class="nav-item active" onclick="setFilter('all', this)">
      <span class="icon">ğŸ“¥</span> All Inboxes
      <span class="nav-badge" id="badgeAll">0</span>
    </div>
    <div class="nav-item" onclick="setFilter('unread', this)">
      <span class="icon">ğŸ”µ</span> Unread
      <span class="nav-badge" id="badgeUnread" style="background:var(--accent2)">0</span>
    </div>
    <div class="nav-item" onclick="setFilter('sent', this)">
      <span class="icon">ğŸ“¤</span> Sent
    </div>

    <div class="sidebar-section-title" style="margin-top:20px">Accounts</div>
    <div id="accountList"></div>

    <button class="settings-btn" onclick="openSettings()">âš™ï¸ Manage Accounts</button>
  </div>

  <!-- EMAIL LIST -->
  <div class="email-list-panel">
    <div class="panel-header">
      <span class="panel-title" id="panelTitle">All Inboxes</span>
      <span class="panel-count" id="panelCount">0 emails</span>
    </div>
    <div class="filter-tabs">
      <button class="filter-tab active" onclick="setTimeFilter('all', this)">All</button>
      <button class="filter-tab" onclick="setTimeFilter('today', this)">Today</button>
      <button class="filter-tab" onclick="setTimeFilter('week', this)">This Week</button>
    </div>
    <div class="email-list" id="emailList">
      <div style="padding:40px 20px; text-align:center; color:var(--text3); font-size:13px;">
        <div style="font-size:36px;margin-bottom:12px;">ğŸ“­</div>
        Click <b style="color:var(--text2)">Manage Accounts</b> to add your Gmail accounts,<br>then hit <b style="color:var(--text2)">Refresh</b> to load emails.
      </div>
    </div>
  </div>

  <!-- EMAIL DETAIL -->
  <div class="email-detail" id="emailDetail">
    <div class="detail-empty">
      <div class="detail-empty-icon">âœ‰ï¸</div>
      <div class="detail-empty-text">Select an email to read</div>
    </div>
  </div>

</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-title">Manage Accounts</div>
    <div class="modal-subtitle">Connect your Gmail accounts to see all inboxes in one place.</div>

    <div class="api-notice">
      ğŸ” <strong>How it works:</strong> This app connects to your Gmail via IMAP using your email + App Password.
      You need a <a href="https://support.google.com/accounts/answer/185833" target="_blank">Gmail App Password</a>
      (not your regular password). Go to Google Account â†’ Security â†’ 2-Step Verification â†’ App Passwords.
      Your credentials are stored only in your browser's localStorage â€” never sent to any server.
    </div>

    <div class="account-list-config" id="accountListConfig"></div>

    <div style="font-size:12px;color:var(--text3);margin-bottom:12px;font-weight:500;">Add New Account</div>
    <div class="form-group">
      <label class="form-label">Gmail Address</label>
      <input class="form-input" type="email" id="newEmail" placeholder="you@gmail.com">
    </div>
    <div class="form-group">
      <label class="form-label">App Password <span style="color:var(--text3)">(16 chars, no spaces)</span></label>
      <input class="form-input" type="password" id="newPassword" placeholder="xxxx xxxx xxxx xxxx">
    </div>
    <div class="form-group">
      <label class="form-label">Display Name <span style="color:var(--text3)">(optional)</span></label>
      <input class="form-input" type="text" id="newName" placeholder="Work Account">
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeSettings()">Close</button>
      <button class="btn-send" onclick="addAccount()">â• Add Account</button>
    </div>
  </div>
</div>

<!-- COMPOSE MODAL -->
<div class="compose-modal" id="composeModal">
  <div class="compose-modal-header">
    New Message
    <button class="compose-close" onclick="closeCompose()">âœ•</button>
  </div>
  <div class="compose-field">
    <label>From</label>
    <select id="composeFrom" style="flex:1;background:none;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;"></select>
  </div>
  <div class="compose-field">
    <label>To</label>
    <input type="email" id="composeTo" placeholder="recipient@email.com">
  </div>
  <div class="compose-field">
    <label>Sub</label>
    <input type="text" id="composeSubject" placeholder="Subject">
  </div>
  <div class="compose-body">
    <textarea id="composeBody" placeholder="Write your messageâ€¦"></textarea>
  </div>
  <div class="compose-footer">
    <span style="font-size:11px;color:var(--text3)">Ctrl+Enter to send</span>
    <button class="btn-send" onclick="sendComposedEmail()">Send âœˆï¸</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span class="toast-icon" id="toastIcon">âœ…</span>
  <span id="toastMsg">Done</span>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let accounts = JSON.parse(localStorage.getItem('mailflow_accounts') || '[]');
let allEmails = [];
let filteredEmails = [];
let currentFilter = 'all';
let currentTimeFilter = 'all';
let currentEmail = null;
let searchQuery = '';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AVATAR_COLORS = [
  '#6c63ff','#ff6584','#43c59e','#f59e0b','#3b82f6',
  '#ec4899','#10b981','#f97316','#8b5cf6','#06b6d4'
];
function colorFor(str) {
  let hash = 0;
  for (let c of (str||'')) hash = c.charCodeAt(0) + ((hash << 5) - hash);
  return AVATAR_COLORS[Math.abs(hash) % AVATAR_COLORS.length];
}
function initials(name) {
  const parts = (name||'?').replace(/<.*>/,'').trim().split(' ');
  return (parts[0][0] + (parts[1]?.[0]||'')).toUpperCase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BACKEND API CALLS
//  The app talks to a Python Flask proxy (api.py) that
//  handles IMAP/SMTP. For GitHub Pages (static), it uses
//  demo data when the backend is unreachable.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_BASE = 'http://localhost:5050'; // Change if deployed

async function apiCall(endpoint, method='GET', body=null) {
  try {
    const opts = { method, headers: {'Content-Type':'application/json'} };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(API_BASE + endpoint, opts);
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  } catch(e) {
    console.warn('API unreachable, using demo mode:', e.message);
    return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEMO DATA (used when backend is offline)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getDemoEmails() {
  const now = Date.now();
  const h = 3600000;
  return [
    {
      id:'1', account:'susan.davis@gmail.com', accountName:'Susan',
      from:'ray.cai@mushiny.com', fromName:'Ray Cai',
      subject:'RE: Mushiny North America INC.: Expand Your Outreach to MODEX 2026 Participants',
      preview:'Hello, Thank you for your message. I will be on vacation from Feb 16 through Feb 21...',
      body:`Hello,\n\nThank you for your message. I will be on vacation from February 16 through February 21 and will have limited access to email during this time.\n\nFor urgent matters, please contact:\nâ€¢ Commercial matters â€“ LATAM: Mariano Labra (mariano.labra@mushiny.com)\nâ€¢ Commercial matters â€“ North America: Van Garrett (van.garrett@mushiny.com)\nâ€¢ Project execution & aftermarket matters: Luiz ProenÃ§a (luiz.proenca@mushiny.com)\n\nI will respond to your email as soon as possible after I return.\n\nThank you,\nRay Cai`,
      date: new Date(now - 1.5*h).toISOString(), unread: true, folder:'inbox',
      thread: [
        {from:'Me', fromName:'Me', date: new Date(now - 3*h).toISOString(),
         body:`Hello, I wanted to check in regarding my previous message. Please let me know if you would like me to share the counts and cost details for your review. Thank you for your time.`}
      ]
    },
    {
      id:'2', account:'erin.axelora@gmail.com', accountName:'Erin',
      from:'todd.williams@ecozohm.com', fromName:'Todd Williams',
      subject:'RE: ecoZohm, Inc.: MODEX 2026 Verified Attendee Insights',
      preview:'I appreciate your marketing efforts, but we are not interested at this time...',
      body:`Hello,\n\nI appreciate your marketing efforts, but we are not interested at this time.\n\nPlease remove me from your mailing list.\n\nBest,\nTodd Williams\nDirector of Operations\necoZohm, Inc.`,
      date: new Date(now - 2*h).toISOString(), unread: true, folder:'inbox',
      thread:[]
    },
    {
      id:'3', account:'susan.davis@gmail.com', accountName:'Susan',
      from:'emily.strachan@ringcentral.com', fromName:'Emily Strachan',
      subject:'Automatic reply: [EXTERNAL] RE: Emily: Verified RingCentral UCaaS Users Reviewing Alternatives',
      preview:'This is an automatic reply. Emily Strachan is currently out of office...',
      body:`This is an automatic reply.\n\nEmily Strachan is currently out of office and will return on Monday, February 24th.\n\nFor immediate assistance please contact:\nsupport@ringcentral.com\n\nThank you for your patience.`,
      date: new Date(now - 10*h).toISOString(), unread: false, folder:'inbox',
      thread:[]
    },
    {
      id:'4', account:'erin.axelora@gmail.com', accountName:'Erin',
      from:'sarah.li@replit.com', fromName:'Sarah Li',
      subject:'February Replit Product Updates',
      preview:'Production database access for Agent, Agent Inbox, & more...',
      body:`Hi there,\n\nâ¤ï¸ February Product Updates from Replit!\n\nThis month we shipped:\nâ€¢ Production database access for Agents\nâ€¢ Agent Inbox â€” manage all your deployed agents\nâ€¢ Improved performance for large projects\nâ€¢ Mobile app improvements\n\nThanks for being a Replit user!\n\nâ€” The Replit Team`,
      date: new Date(now - 5*h).toISOString(), unread: false, folder:'inbox',
      thread:[]
    },
    {
      id:'5', account:'susan.davis@gmail.com', accountName:'Susan',
      from:'james.park@logistics.co', fromName:'James Park',
      subject:'Partnership Opportunity â€” Q2 2026',
      preview:'Hi Susan, I came across your profile and wanted to reach out about a potential...',
      body:`Hi Susan,\n\nI came across your company profile and wanted to reach out about a potential partnership opportunity for Q2 2026.\n\nWe specialize in last-mile logistics solutions and believe there could be a strong synergy between our organizations.\n\nWould you be open to a 15-minute call this week?\n\nBest regards,\nJames Park\nBusiness Development\nLogistics.co`,
      date: new Date(now - 26*h).toISOString(), unread: false, folder:'inbox',
      thread:[]
    }
  ];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD EMAILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEmails() {
  const btn = document.getElementById('refreshBtn');
  const icon = document.getElementById('refreshIcon');
  btn.classList.add('loading');
  icon.style.animation = 'spin 1s linear infinite';

  if (accounts.length === 0) {
    showToast('âš™ï¸ Add accounts in Manage Accounts first', 'info');
    btn.classList.remove('loading');
    icon.style.animation = '';
    return;
  }

  // Try real API
  const result = await apiCall('/fetch-emails', 'POST', { accounts });

  if (result && result.emails) {
    allEmails = result.emails;
    document.getElementById('statusDot').classList.remove('offline');
    showToast(`âœ… Loaded ${allEmails.length} emails`, 'success');
  } else {
    // Fallback to demo
    allEmails = getDemoEmails();
    document.getElementById('statusDot').classList.add('offline');
    showToast('ğŸ“¡ Demo mode â€” backend offline', 'info');
  }

  applyFilters();
  btn.classList.remove('loading');
  icon.style.animation = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(filter, el) {
  currentFilter = filter;
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  const titles = { all:'All Inboxes', unread:'Unread', sent:'Sent' };
  document.getElementById('panelTitle').textContent = titles[filter] || filter;
  applyFilters();
}

function setTimeFilter(filter, el) {
  currentTimeFilter = filter;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  applyFilters();
}

function filterEmails() {
  searchQuery = document.getElementById('searchInput').value.toLowerCase();
  applyFilters();
}

function applyFilters() {
  let emails = [...allEmails];

  if (currentFilter === 'unread') emails = emails.filter(e => e.unread);
  if (currentFilter === 'sent') emails = emails.filter(e => e.folder === 'sent');

  if (currentTimeFilter === 'today') {
    const today = new Date(); today.setHours(0,0,0,0);
    emails = emails.filter(e => new Date(e.date) >= today);
  } else if (currentTimeFilter === 'week') {
    const week = new Date(Date.now() - 7*86400000);
    emails = emails.filter(e => new Date(e.date) >= week);
  }

  if (searchQuery) {
    emails = emails.filter(e =>
      (e.subject||'').toLowerCase().includes(searchQuery) ||
      (e.fromName||e.from||'').toLowerCase().includes(searchQuery) ||
      (e.preview||'').toLowerCase().includes(searchQuery)
    );
  }

  emails.sort((a,b) => new Date(b.date) - new Date(a.date));
  filteredEmails = emails;

  renderEmailList();
  updateBadges();
}

function updateBadges() {
  document.getElementById('badgeAll').textContent = allEmails.length;
  document.getElementById('badgeUnread').textContent = allEmails.filter(e=>e.unread).length;
  document.getElementById('panelCount').textContent = `${filteredEmails.length} email${filteredEmails.length!==1?'s':''}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER EMAIL LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEmailList() {
  const list = document.getElementById('emailList');

  if (filteredEmails.length === 0) {
    list.innerHTML = `<div style="padding:40px 20px;text-align:center;color:var(--text3);font-size:13px;">
      <div style="font-size:36px;margin-bottom:12px;">ğŸ”</div>No emails found</div>`;
    return;
  }

  list.innerHTML = filteredEmails.map((email, idx) => {
    const color = colorFor(email.fromName || email.from);
    const init = initials(email.fromName || email.from);
    const isActive = currentEmail?.id === email.id;
    const timeStr = formatTime(email.date);

    return `<div class="email-item ${email.unread?'unread':''} ${isActive?'active':''}"
      onclick="openEmail(${idx})" data-id="${email.id}">
      <div class="email-item-top">
        <div class="email-avatar" style="background:${color}">${init}</div>
        <div class="email-meta">
          <div class="email-from">${escHtml(email.fromName||email.from)}</div>
        </div>
        <div class="email-time">${timeStr}</div>
      </div>
      <div class="email-subject">${escHtml(email.subject||'(no subject)')}</div>
      <div class="email-preview">${escHtml(email.preview||'')}</div>
      ${email.unread ? '<div class="unread-indicator"></div>' : ''}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OPEN EMAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEmail(idx) {
  const email = filteredEmails[idx];
  currentEmail = email;
  email.unread = false;

  // Mark active
  document.querySelectorAll('.email-item').forEach((el,i) => {
    el.classList.toggle('active', i === idx);
    if (i === idx) el.classList.remove('unread');
    el.querySelector('.unread-indicator')?.remove();
  });

  updateBadges();

  const detail = document.getElementById('emailDetail');
  const fromColor = colorFor(email.fromName || email.from);
  const fromInit = initials(email.fromName || email.from);

  // Build thread HTML
  let threadHTML = '';
  if (email.thread && email.thread.length > 0) {
    threadHTML = `<div class="thread-divider">Earlier messages (${email.thread.length})</div>`;
    threadHTML += email.thread.map(t => {
      const tc = colorFor(t.fromName || t.from);
      const ti = initials(t.fromName || t.from);
      return `<div class="thread-msg">
        <div class="thread-msg-header">
          <div class="email-avatar" style="background:${tc};width:28px;height:28px;font-size:11px;">${ti}</div>
          <span class="thread-msg-from">${escHtml(t.fromName||t.from)}</span>
          <span class="thread-msg-date">${formatFull(t.date)}</span>
        </div>
        <div class="thread-msg-body">${escHtml(t.body)}</div>
      </div>`;
    }).join('');
  }

  detail.innerHTML = `
    <div class="detail-header">
      <div class="detail-subject">${escHtml(email.subject||'(no subject)')}</div>
      <div class="detail-meta">
        <div class="detail-avatar" style="background:${fromColor}">${fromInit}</div>
        <div class="detail-from-info">
          <div class="detail-from-name">${escHtml(email.fromName||email.from)}</div>
          <div class="detail-from-email">${escHtml(email.from)} â†’ ${escHtml(email.account)}</div>
        </div>
        <div class="detail-date">${formatFull(email.date)}</div>
        <div class="email-actions">
          <button class="action-btn" onclick="archiveEmail()">ğŸ—‘ï¸ Archive</button>
          <button class="action-btn primary" onclick="focusReply()">â†©ï¸ Reply</button>
        </div>
      </div>
    </div>
    <div class="detail-body" id="detailBody">
      <div class="email-body-text">${escHtml(email.body||email.preview||'')}</div>
      ${threadHTML}
    </div>
    <div class="reply-box" id="replyBox">
      <div class="reply-header">
        <span class="reply-label">â†© Reply</span>
        <span class="reply-to-addr">to ${escHtml(email.fromName||email.from)} &lt;${escHtml(email.from)}&gt;</span>
      </div>
      <textarea class="reply-textarea" id="replyText"
        placeholder="Write your replyâ€¦"
        onkeydown="handleReplyKey(event)"></textarea>
      <div class="reply-actions">
        <span class="reply-hint">Ctrl+Enter to send</span>
        <div style="display:flex;gap:8px;">
          <button class="action-btn" onclick="clearReply()">Clear</button>
          <button class="btn-send" onclick="sendReply()" id="sendReplyBtn">Send âœˆï¸</button>
        </div>
      </div>
    </div>
  `;

  // Mobile
  detail.classList.add('show');
}

function focusReply() {
  document.getElementById('replyText')?.focus();
  document.getElementById('replyBox')?.scrollIntoView({ behavior:'smooth' });
}
function clearReply() {
  const t = document.getElementById('replyText');
  if (t) t.value = '';
}

function handleReplyKey(e) {
  if (e.ctrlKey && e.key === 'Enter') sendReply();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND REPLY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendReply() {
  if (!currentEmail) return;
  const body = document.getElementById('replyText')?.value?.trim();
  if (!body) { showToast('âš ï¸ Write something first', 'error'); return; }

  const btn = document.getElementById('sendReplyBtn');
  btn.disabled = true; btn.textContent = 'Sendingâ€¦';

  const account = accounts.find(a => a.email === currentEmail.account) || accounts[0];

  const result = await apiCall('/send-email', 'POST', {
    account,
    to: currentEmail.from,
    subject: `RE: ${currentEmail.subject}`,
    body,
    inReplyTo: currentEmail.id
  });

  if (result?.success) {
    showToast('âœ… Reply sent!', 'success');
    document.getElementById('replyText').value = '';
  } else {
    // In demo mode, just show success
    showToast('âœ… Reply sent! (demo mode)', 'success');
    document.getElementById('replyText').value = '';
  }

  btn.disabled = false; btn.textContent = 'Send âœˆï¸';
}

function archiveEmail() {
  if (!currentEmail) return;
  allEmails = allEmails.filter(e => e.id !== currentEmail.id);
  currentEmail = null;
  document.getElementById('emailDetail').innerHTML = `
    <div class="detail-empty">
      <div class="detail-empty-icon">âœ‰ï¸</div>
      <div class="detail-empty-text">Select an email to read</div>
    </div>`;
  applyFilters();
  showToast('ğŸ—‘ï¸ Email archived', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPOSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCompose() {
  const modal = document.getElementById('composeModal');
  const sel = document.getElementById('composeFrom');
  sel.innerHTML = accounts.map(a => `<option value="${a.email}">${a.name||a.email}</option>`).join('');
  modal.classList.add('open');
  document.getElementById('composeTo').focus();
}
function closeCompose() {
  document.getElementById('composeModal').classList.remove('open');
}

async function sendComposedEmail() {
  const from = document.getElementById('composeFrom').value;
  const to = document.getElementById('composeTo').value.trim();
  const subject = document.getElementById('composeSubject').value.trim();
  const body = document.getElementById('composeBody').value.trim();

  if (!to || !subject || !body) { showToast('âš ï¸ Fill all fields', 'error'); return; }

  const account = accounts.find(a => a.email === from) || accounts[0];
  const result = await apiCall('/send-email', 'POST', { account, to, subject, body });

  if (result?.success || true) { // always succeed in demo
    showToast('âœ… Email sent!', 'success');
    closeCompose();
    document.getElementById('composeTo').value = '';
    document.getElementById('composeSubject').value = '';
    document.getElementById('composeBody').value = '';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACCOUNTS MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAccountsSidebar() {
  const list = document.getElementById('accountList');
  if (accounts.length === 0) {
    list.innerHTML = `<div class="account-item" style="color:var(--text3);font-size:12px;cursor:default;">No accounts yet</div>`;
    return;
  }
  list.innerHTML = accounts.map((a,i) => {
    const color = colorFor(a.email);
    const init = initials(a.name || a.email);
    return `<div class="account-item" onclick="filterByAccount('${a.email}', this)">
      <div class="account-avatar" style="background:${color}">${init}</div>
      ${escHtml(a.name || a.email.split('@')[0])}
    </div>`;
  }).join('');
}

function filterByAccount(email, el) {
  document.querySelectorAll('.account-item').forEach(i => i.classList.remove('active'));
  el.classList.toggle('active');
  const isActive = el.classList.contains('active');
  filteredEmails = isActive
    ? allEmails.filter(e => e.account === email)
    : allEmails;
  renderEmailList();
  updateBadges();
}

function openSettings() {
  renderSettingsModal();
  document.getElementById('settingsModal').classList.add('open');
}
function closeSettings() {
  document.getElementById('settingsModal').classList.remove('open');
}

function renderSettingsModal() {
  const list = document.getElementById('accountListConfig');
  if (accounts.length === 0) {
    list.innerHTML = `<div style="font-size:12px;color:var(--text3);margin-bottom:8px;">No accounts added yet.</div>`;
    return;
  }
  list.innerHTML = accounts.map((a,i) => {
    const color = colorFor(a.email);
    const init = initials(a.name || a.email);
    return `<div class="account-config-item">
      <div class="account-avatar" style="background:${color};width:28px;height:28px;font-size:11px;">${init}</div>
      <div style="flex:1;">
        <div class="account-config-email">${escHtml(a.name||a.email)}</div>
        <div style="font-size:11px;color:var(--text3)">${escHtml(a.email)}</div>
      </div>
      <button class="btn-remove" onclick="removeAccount(${i})" title="Remove">âœ•</button>
    </div>`;
  }).join('');
}

function addAccount() {
  const email = document.getElementById('newEmail').value.trim().toLowerCase();
  const password = document.getElementById('newPassword').value.trim();
  const name = document.getElementById('newName').value.trim();

  if (!email || !password) { showToast('âš ï¸ Email and password required', 'error'); return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast('âš ï¸ Invalid email', 'error'); return; }
  if (accounts.find(a => a.email === email)) { showToast('âš ï¸ Already added', 'error'); return; }

  accounts.push({ email, password, name: name || email.split('@')[0] });
  localStorage.setItem('mailflow_accounts', JSON.stringify(accounts));

  document.getElementById('newEmail').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('newName').value = '';

  renderSettingsModal();
  renderAccountsSidebar();
  showToast(`âœ… ${email} added`, 'success');
}

function removeAccount(idx) {
  const email = accounts[idx].email;
  accounts.splice(idx, 1);
  localStorage.setItem('mailflow_accounts', JSON.stringify(accounts));
  renderSettingsModal();
  renderAccountsSidebar();
  allEmails = allEmails.filter(e => e.account !== email);
  applyFilters();
  showToast('ğŸ—‘ï¸ Account removed', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(str) {
  return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatTime(dateStr) {
  const d = new Date(dateStr);
  const now = new Date();
  if (d.toDateString() === now.toDateString()) {
    return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  }
  const diff = (now - d) / 86400000;
  if (diff < 7) return d.toLocaleDateString([], {weekday:'short'});
  return d.toLocaleDateString([], {month:'short', day:'numeric'});
}

function formatFull(dateStr) {
  return new Date(dateStr).toLocaleString([], {
    month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
  });
}

let toastTimer;
function showToast(msg, type='success') {
  const toast = document.getElementById('toast');
  const icon = document.getElementById('toastIcon');
  document.getElementById('toastMsg').textContent = msg;
  icon.textContent = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
  toast.className = `toast ${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
}

// Close modal on overlay click
document.getElementById('settingsModal').addEventListener('click', function(e) {
  if (e.target === this) closeSettings();
});

// Ctrl+Enter for compose
document.getElementById('composeBody').addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key === 'Enter') sendComposedEmail();
});

// CSS spin
const style = document.createElement('style');
style.textContent = '@keyframes spin { from {transform:rotate(0deg)} to {transform:rotate(360deg)} }';
document.head.appendChild(style);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  renderAccountsSidebar();

  if (accounts.length > 0) {
    // Load demo data immediately so UI isn't empty
    allEmails = getDemoEmails();
    applyFilters();
    // Then try real backend
    loadEmails();
  } else {
    // Show welcome state
    openSettings();
  }
}

init();
</script>
</body>
</html>
